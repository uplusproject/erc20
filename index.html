<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMask Wallet Connect</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 50px;
        }

        button {
            margin: 10px 0;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <h2>MetaMask Wallet Interaction</h2>

    <button id="connectWallet">Connect Wallet</button>
    <button id="signPermit" disabled>Sign Permit</button>
    <button id="transferTokens" disabled>Transfer Tokens</button>

    <p id="status"></p>

    <script>
        let accounts;
        const contractABI = [
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "spender",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "deadline",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint8",
                        "name": "v",
                        "type": "uint8"
                    },
                    {
                        "internalType": "bytes32",
                        "name": "r",
                        "type": "bytes32"
                    },
                    {
                        "internalType": "bytes32",
                        "name": "s",
                        "type": "bytes32"
                    }
                ],
                "name": "permit",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "recipient",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "transferFrom",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        const contractAddress = '0xYourContractAddress'; // 填入你的合约地址

        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (window.ethereum) {
                try {
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    document.getElementById('status').textContent = `Wallet connected: ${accounts[0]}`;
                    document.getElementById('signPermit').disabled = false;
                    document.getElementById('transferTokens').disabled = false;
                } catch (error) {
                    document.getElementById('status').textContent = 'Connection failed: ' + error.message;
                }
            } else {
                document.getElementById('status').textContent = 'MetaMask not installed!';
            }
        });

        document.getElementById('signPermit').addEventListener('click', async () => {
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const contract = new ethers.Contract(contractAddress, contractABI, signer);

                // 获取签名所需的参数，以下为示例，请根据实际需求填充参数
                const owner = accounts[0];
                const spender = '0xSpenderAddress'; // 填入你想要授权的地址
                const value = ethers.utils.parseUnits('1.0', 18); // 授权1个代币
                const deadline = Math.floor(Date.now() / 1000) + 60 * 60; // 1小时后过期
                const nonce = 0; // 获取正确的 nonce 值

                const domain = {
                    name: 'YourTokenName',
                    version: '1',
                    chainId: 1, // Ethereum主网chainId为1
                    verifyingContract: contractAddress,
                };

                const types = {
                    Permit: [
                        { name: 'owner', type: 'address' },
                        { name: 'spender', type: 'address' },
                        { name: 'value', type: 'uint256' },
                        { name: 'nonce', type: 'uint256' },
                        { name: 'deadline', type: 'uint256' },
                    ],
                };

                const signature = await signer._signTypedData(domain, types, {
                    owner: owner,
                    spender: spender,
                    value: value.toString(),
                    nonce: nonce,
                    deadline: deadline,
                });

                const { v, r, s } = ethers.utils.splitSignature(signature);

                await contract.permit(owner, spender, value, deadline, v, r, s);

                document.getElementById('status').textContent = 'Signed and permitted successfully!';
            } catch (error) {
                document.getElementById('status').textContent = 'Sign failed: ' + error.message;
            }
        });

        document.getElementById('transferTokens').addEventListener('click', async () => {
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const contract = new ethers.Contract(contractAddress, contractABI, signer);

                const sender = accounts[0];
                const recipient = '0xRecipientAddress'; // 填入接收代币的地址
                const amount = ethers.utils.parseUnits('1.0', 18); // 转移1个代币

                await contract.transferFrom(sender, recipient, amount);

                document.getElementById('status').textContent = 'Tokens transferred successfully!';
            } catch (error) {
                document.getElementById('status').textContent = 'Transfer failed: ' + error.message;
            }
        });
    </script>
</body>
</html>
